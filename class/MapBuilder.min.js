export default class MapBuilder{constructor(t,e,i,s){this.racine=t,this.separator="/",this.output=document.getElementById(e),this.back=document.getElementById(i),this.loading=document.getElementById(s),this.map=[],this.keys=[],this.begin="",this.currentPath="",this.currentData=[],this.firstname="root",this.back.addEventListener("click",()=>{this.currentPath=this.begin,this.update()})}rename(t){this.firstname=t}addReader(t){this.reader=t}addListner(t){this.listener=t}setFileIcon(t){this.fileIcon=t}setFolderIcon(t){this.folderIcon=t}setSeparator(t){this.separator=t}build(){this.getMap().then(t=>{this.begin=Object.keys(t)[0],this.currentPath=this.begin,this.loading.remove(),this.map=t,this.keys=this.getKey(t),this.update(),void 0!==this.listener&&this.listener.init()})}async getMap(){var t=await fetch(this.racine);return t.ok||alert("Error"),t.json()}lvl(){return this.currentPath.split(this.separator).length}update(){var t=document.createElement("div"),e=(t.classList.add("output-block"),this.output.childElementCount);this.currentData=this.folderAt(this.currentPath,this.keys),this.checkLvl(e);let i=document.createElement("div");i.classList.add("list"),i.classList.add("list-head");var e=document.createElement("div"),s=(e.classList.add("list-heading"),this.currentDir()),s=(e.textContent=".."==s?this.firstname:s,i.appendChild(e),i.setAttribute("link",this.currentPath),this.containIndex(this.currentPath)?i.ondblclick=()=>{window.location.href=i.getAttribute("link")}:i.ondblclick=()=>{alert("can't find index")},t.appendChild(i),this.setContent());this.back.innerHTML=this.lvl(),t.appendChild(s),this.addLvl(t),void 0!==this.listener&&this.listener.init()}setContent(){var t=document.createElement("div");return t.classList.add("folder-list"),this.setFolders(t),this.setFiles(t),t}setFolders(i){for(let e=0;e<this.currentData.length;e++){let t=document.createElement("div");t.setAttribute("link",this.currentPath+this.separator+this.currentData[e]),t.classList.add("list"),t.onclick=()=>{this.currentPath=t.getAttribute("link"),this.setActive(t),this.update()},this.containIndex(this.currentPath+this.separator+this.currentData[e])?t.ondblclick=()=>{window.location.href=t.getAttribute("link")}:t.ondblclick=()=>{alert("can't find index")};var s=document.createElement("img"),r=(s.src=this.folderIcon,document.createElement("div")),n=(r.classList.add("folder-name"),document.createElement("p"));n.textContent=this.currentData[e],r.appendChild(n),t.appendChild(s),t.appendChild(r),i.appendChild(t)}}setFiles(i){var s=this.map[this.currentPath];if(void 0!==s)for(let e=0;e<s.length;e++){let t=document.createElement("div");t.setAttribute("link",this.currentPath+this.separator+s[e]),t.classList.add("list"),t.onclick=()=>{void 0===this.reader?alert("can't read file, add a FileViewer"):this.reader.readFile(t.getAttribute("link"))};var r=document.createElement("img"),n=(r.src=this.fileIcon,document.createElement("div")),a=(n.classList.add("folder-name"),document.createElement("p"));a.textContent=s[e],n.appendChild(a),t.appendChild(r),t.appendChild(n),i.appendChild(t)}}containIndex(t){var e=this.map[t],i=[];for(let t=0;t<e.length;t++)if(i.push(e[t].split(".")[0]),"index"==e[t].split(".")[0])return!0;return!1}setActive(t){var e=t.parentNode.childNodes;for(let t=0;t<e.length;t++)e[t].classList.remove("active");t.classList.add("active")}checkLvl(e){var i=this.lvl();for(let t=e;t>i-1;t--)this.unsetLvl()}unsetLvl(){this.output.removeChild(this.output.lastElementChild)}addLvl(t){this.output.appendChild(t)}currentDir(){var t=this.currentPath.split(this.separator);return t[t.length-1]}getKey(t){let e=[];return Object.keys(t).forEach(t=>{e.includes(t)||e.push(t)}),e}folderAt(e,i){var s=[];let r="";for(let t=0;t<i.length;t++)i[t].includes(e+"/")&&2==(r=(r=i[t].split(e)[1]).split(this.separator)).length&&s.push(r[1]);return s}}